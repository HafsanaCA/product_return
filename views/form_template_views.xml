<?xml version="1.0" encoding="UTF-8" ?>
<odoo>
    <template id="sale_return_form_template" name="Sale Return Form">
        <t t-call="website.layout">
            <div class="container my-5">
                <h2>Return Order - <t t-esc="sale_order.name"/></h2>
                <t t-if="error">
                    <div class="alert alert-danger">
                        <t t-if="error == 'no_reason'">Please provide a reason for the return.</t>
                        <t t-if="error == 'no_valid_products'">Please select at least one valid product to return.</t>
                        <t t-if="error == 'server_error'">Server Error: <t t-esc="message or 'An unexpected error occurred. Please try again.'"/></t>
                        <t t-if="error == 'csrf_error'">CSRF Error: Invalid or missing CSRF token. Please refresh the page and try again.</t>
                    </div>
                </t>
                <div class="mb-3">
                    <label for="partner" class="form-label fw-bold">Customer</label>
                    <input type="text" id="partner" name="partner" class="form-control"
                           t-att-value="sale_order.partner_id.name" readonly="1"/>
                </div>
                <form action="/sale_return" method="post" id="return_form">
                    <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                    <input type="hidden" name="order_id" t-att-value="sale_order.id"/>
                    <t t-foreach="sale_order.order_line.filtered(lambda l: l.qty_delivered > 0)" t-as="line">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input"
                                           t-att-name="'product_%d' % line.product_id.id"
                                           t-att-id="'product_%d' % line.product_id.id"
                                           t-att-value="line.product_id.id"
                                           style="border: 1px solid #dee2e6;"/>
                                    <label class="form-check-label"
                                           t-att-for="'product_%d' % line.product_id.id"
                                           t-esc="line.product_id.name"/>
                                </div>
                            </div>
                            <br/>
                            <br/>
                            <div>
                                <input type="number" class="form-control"
                                       t-att-name="'qty_%d' % line.product_id.id"
                                       t-att-max="line.qty_delivered"
                                       min="0" placeholder="Return Quantity"
                                       style="border: 1px solid #dee2e6;"/>
                            </div>
                        </div>
                    </t>
                    <div class="form-group mb-4">
                        <label class="fw-bold" style="margin-bottom:5px;">Reason for Return</label>
                        <textarea name="reason" class="form-control" style="border: 1px solid #dee2e6;"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">Submit</button>
                    <a href="/my/orders" class="btn btn-secondary">Cancel</a>
                </form>
                <script>
                    document.getElementById('return_form').addEventListener('submit', function(event) {
                        const formData = new FormData(this);
                        console.log('Form data:', Object.fromEntries(formData));
                        const csrfToken = formData.get('csrf_token');
                        if (!csrfToken) {
                            console.error('CSRF token is missing in form submission!');
                        } else {
                            console.log('CSRF token:', csrfToken);
                        }
                    });
                </script>
            </div>
        </t>
    </template>
</odoo>
